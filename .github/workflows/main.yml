name: Docker_v2

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug

jobs:
  build:

    env:
      UPDATE: false
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      #Check if the version of kea has changed
      - name: Check kea version
        run: |
          kea_old=$(cat .github/VERSION | grep kea | cut -d "=" -f2)
          kea=$(docker run --quiet alpine:latest sh -c "apk -q update && apk info kea | head -n1 | cut -d ' ' -f1")
          if [ "$kea_old" != "$kea" ]; then
             echo "Found new version of kea."
             echo "UPDATE=true" >> $GITHUB_ENV
          fi
     
      # Install the cosign tool except on PR
      # https://github.com/sigstore/cosign-installer
      - name: Install cosign
        if: ${{ (github.event_name != 'pull_request') && (env.UPDATE == 'true') }}
        uses: sigstore/cosign-installer@f3c664df7af409cb4873aa5068053ba9d61a57b6 #v2.6.0
        with:
          cosign-release: 'v1.13.1'
     
      #- name: Save version
      #  #if: ${{ (github.event_name != 'pull_request') && (env.UPDATE == 'true') }}
      #  if: ${{ env.UPDATE == 'true' }}
      #  run: |
      #      #echo "kea=$kea" > ".github/VERSION"
      #      echo "kea=kea-2.2.0-r11" > ".github/VERSION"
      #      git config --global user.name 'dotsoltecti'
      #      git config --global user.email 'dotsoltecti@users.noreply.github.com'
      #      git commit -am "Update version"
      #      git push
      #      echo "Saved values"
